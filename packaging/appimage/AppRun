#!/bin/bash
set -e
APPDIR="$(cd "$(dirname "$0")" && pwd)"
APPIMAGE="${APPIMAGE:-}"

if [ "$1" = "--daemon" ]; then
  exec "$APPDIR/usr/bin/appimage-manager-daemon"
fi

if [ -n "$APPIMAGE" ]; then
  CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/appimage-manager"
  SYSTEMD_USER_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/systemd/user"
  INSTALL_MARKER="$CONFIG_DIR/.appimage-installed"
  APPLICATIONS_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/applications"

  if [ ! -f "$INSTALL_MARKER" ]; then
    mkdir -p "$CONFIG_DIR"
    mkdir -p "$SYSTEMD_USER_DIR"
    [ -f "$CONFIG_DIR/config.json" ] || echo '{"watch_directories":[]}' > "$CONFIG_DIR/config.json"
    cat > "$SYSTEMD_USER_DIR/appimage-manager.service" << EOF
[Unit]
Description=AppImage Manager daemon
After=graphical-session.target

[Service]
Type=simple
ExecStart=$APPIMAGE --daemon
Restart=on-failure
RestartSec=5

[Install]
WantedBy=default.target
EOF
    systemctl --user daemon-reload
    mkdir -p "$APPLICATIONS_DIR"
    cat > "$APPLICATIONS_DIR/appimage-manager.desktop" << EOF
[Desktop Entry]
Type=Application
Name=AppImage Manager
Comment=Manage AppImage applications
Exec=$APPIMAGE
Icon=appimage-manager
Categories=Utility;
EOF
    touch "$INSTALL_MARKER"
  fi
  systemctl --user is-active --quiet appimage-manager 2>/dev/null || systemctl --user start appimage-manager
fi

exec "$APPDIR/usr/bin/appimage-manager-gui" "$@"
